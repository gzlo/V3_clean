# ===================== CONFIGURACI칍N MOODLE BACKUP V3 =====================
# Archivo de configuraci칩n externa para personalizar el comportamiento del script
# Copiar este archivo como 'moodle_backup.conf' y personalizar seg칰n necesidades
#
# UBICACIONES V츼LIDAS (orden de prioridad):
#   ./moodle_backup.conf              # Local (mayor prioridad)
#   /etc/moodle_backup.conf           # Global del sistema
#   [directorio_script]/moodle_backup.conf # Junto al script
#
# ORDEN DE CARGA:
#   1. Variables de entorno (mayor prioridad)
#   2. Archivo de configuraci칩n encontrado
#   3. Auto-detecci칩n de rutas y configuraciones
#   4. Valores por defecto del script
#
# USO:
#   ./moodle_backup.sh --show-config  # Ver configuraci칩n cargada
#   ./moodle_backup.sh               # Ejecutar con configuraci칩n
# =========================================================================

# ===================== CONFIGURACI칍N UNIVERSAL MULTI-PANEL =====================
# Tipo de panel de control del servidor (afecta la auto-detecci칩n de rutas)
# Valores: auto, cpanel, plesk, directadmin, vestacp, ispconfig, manual
PANEL_TYPE=auto

# Requerir configuraci칩n obligatoria (recomendado=true para producci칩n)
# Si es 'true', no se realizar치 auto-detecci칩n y se requerir치 configuraci칩n manual
# Si es 'false', se intentar치 auto-detectar rutas seg칰n el panel detectado
REQUIRE_CONFIG=false

# Nombre del dominio (necesario para algunos paneles como Plesk)
# Ejemplos: ejemplo.com, moodle.ejemplo.com
DOMAIN_NAME=""

# B칰squeda agresiva en todo el sistema si no se encuentra Moodle en ubicaciones t칤picas
# ADVERTENCIA: Puede ser lenta en sistemas grandes
AUTO_DETECT_AGGRESSIVE=true

# ===================== IDENTIFICACI칍N DEL CLIENTE =====================
# Nombre 칰nico del cliente (usado en nombres de archivos y carpetas)
# IMPORTANTE: Sin espacios, solo letras, n칰meros y guiones bajos
CLIENT_NAME=ejemplo_cliente

# Descripci칩n del cliente para logs y notificaciones
CLIENT_DESCRIPTION="Instalaci칩n Moodle Ejemplo"

# ===================== CONFIGURACI칍N DEL SERVIDOR =====================
# Usuario del sistema (panel-espec칤fico)
# - cPanel: usuario de cPanel
# - Plesk: usuario o dominio
# - DirectAdmin: usuario de DirectAdmin
# - VestaCP: usuario de VestaCP
# - Manual: usuario del sistema (opcional)
PANEL_USER=""
# Ejemplos por panel:
# cPanel:        PANEL_USER=miusuario
# Plesk:         PANEL_USER=midominio_com (a veces el usuario es irrelevante)
# DirectAdmin:   PANEL_USER=usuario_da
# VestaCP:       PANEL_USER=usuario_vesta
# Manual:        PANEL_USER="" (se usa $USER autom치ticamente)
#
# NOTA: Tambi칠n acepta CPANEL_USER por compatibilidad hacia atr치s

# ===================== RUTAS DE MOODLE (PANEL-ESPEC칈FICAS) =====================
# Directorio web de Moodle (si se deja vac칤o, se auto-detecta seg칰n el panel)
# 
# RUTAS T칈PICAS POR PANEL:
# cPanel:        /home/usuario/public_html[/moodle]
# Plesk:         /var/www/vhosts/dominio.com/httpdocs[/moodle]
# DirectAdmin:   /home/usuario/domains/dominio.com/public_html[/moodle]
# VestaCP:       /home/usuario/web/dominio.com/public_html[/moodle]
# ISPConfig:     /var/www/dominio.com/web[/moodle]
# Manual:        /var/www/html[/moodle], /opt/moodle, etc.
WWW_DIR=""

# Directorio de datos de Moodle (si se deja vac칤o, se auto-detecta desde config.php)
# 
# UBICACIONES T칈PICAS POR PANEL:
# cPanel:        /home/usuario/moodledata
# Plesk:         /var/www/vhosts/dominio.com/moodledata
# DirectAdmin:   /home/usuario/moodledata o /home/usuario/domains/dominio.com/moodledata
# VestaCP:       /home/usuario/moodledata o /home/usuario/web/dominio.com/moodledata
# ISPConfig:     /var/www/dominio.com/moodledata
# Manual:        /var/moodledata, /opt/moodledata, etc.
MOODLEDATA_DIR=""

# Directorio temporal para backups (debe tener suficiente espacio)
TMP_DIR="/tmp/moodle_backup"

# ===================== CONFIGURACI칍N DE BASE DE DATOS =====================
# Host de la base de datos (normalmente localhost para todos los paneles)
DB_HOST=localhost

# Nombre de la base de datos (si se deja vac칤o, se auto-detecta desde config.php)
DB_NAME=""
# Ejemplo: DB_NAME=mi_moodle_db

# Usuario de la base de datos (si se deja vac칤o, se auto-detecta desde config.php)
DB_USER=""
# Ejemplo: DB_USER=mi_usuario_db

# ===================== CONFIGURACI칍N DE CONTRASE칌A DE BASE DE DATOS =====================
# 游댏 CONFIGURACI칍N SEGURA DE CONTRASE칌A - ORDEN DE B칔SQUEDA:
#
# 1. Variable de entorno MYSQL_PASSWORD (M츼S SEGURO)
#    export MYSQL_PASSWORD="tu_password_aqu칤"
#
# 2. Archivo protegido /etc/mysql/backup.pwd (RECOMENDADO)
#    sudo echo "tu_password_aqu칤" > /etc/mysql/backup.pwd
#    sudo chmod 600 /etc/mysql/backup.pwd
#    sudo chown root:root /etc/mysql/backup.pwd
#
# 3. Esta variable DB_PASS (MENOS SEGURO - solo para desarrollo)
#    丘멆잺  NO recomendado para producci칩n ya que queda en texto plano
#
# IMPORTANTE: Si usas opciones 1 o 2, deja comentada o vac칤a la l칤nea DB_PASS
# DB_PASS=mi_password_secreto

# VERIFICAR CONFIGURACI칍N:
# Despu칠s de configurar, ejecuta: ./moodle_backup.sh --test
# para verificar que la conexi칩n a la base de datos funcione correctamente.

# ===================== CONFIGURACI칍N DE GOOGLE DRIVE =====================
# Remote de rclone configurado para Google Drive
# Formato: nombre_remote:carpeta_destino
GDRIVE_REMOTE=gdrive:moodle_backups

# N칰mero m치ximo de carpetas de backup a mantener en Google Drive
# El script mantendr치 las N carpetas m치s recientes
MAX_BACKUPS_GDRIVE=2

# ===================== CONFIGURACI칍N DE RENDIMIENTO =====================
# Forzar n칰mero espec칤fico de threads (0 = autom치tico seg칰n horario)
# 칔til para servidores con recursos limitados o dedicados
FORCE_THREADS=0

# Forzar nivel de compresi칩n espec칤fico (1-22)
# 1=r치pido/menos compresi칩n, 22=lento/m치xima compresi칩n
FORCE_COMPRESSION_LEVEL=1

# Horario optimizado con m치s recursos (formato: HH-HH, 24h)
# Durante estas horas se usan m치s threads y recursos
OPTIMIZED_HOURS=02-08

# Timeout personalizado para subidas (segundos, 0=autom치tico)
# 칔til para conexiones lentas o archivos muy grandes
CUSTOM_UPLOAD_TIMEOUT=0

# ===================== CONFIGURACI칍N DE MANTENIMIENTO =====================
# T칤tulo personalizado para p치gina de mantenimiento de Moodle
MAINTENANCE_TITLE="Mantenimiento - Moodle"

# ===================== CONFIGURACI칍N DE LOGGING =====================
# Archivo de log principal (se puede personalizar por cliente)
LOG_FILE="/var/log/moodle_backup_${CLIENT_NAME}.log"
# Alternativa est치ndar: LOG_FILE="/var/log/moodle_backup.log"

# Activar diagn칩sticos extendidos (true/false)
# Incluye m치s informaci칩n en logs pero consume m치s espacio
EXTENDED_DIAGNOSTICS=true

# ===================== CONFIGURACI칍N DE NOTIFICACIONES =====================
# 丘멆잺  OBLIGATORIO: Configure al menos un email para recibir notificaciones
# Sin esta configuraci칩n, el script NO funcionar치 y mostrar치 error
#
# Reemplace 'tu-email@ejemplo.com' con su email real
NOTIFICATION_EMAILS_EXTRA="tu-email@ejemplo.com"
#
# Para m칰ltiples emails, separe con comas:
# NOTIFICATION_EMAILS_EXTRA="admin@tu-dominio.com,backup@tu-dominio.com,soporte@tu-dominio.com"
# 
# FORMATO V츼LIDO: Direcciones de email separadas por comas sin espacios extras

# ===================== NOTAS Y COMENTARIOS =====================
# Este archivo permite personalizar el comportamiento del script
# sin modificar el c칩digo principal
# 
# Orden de precedencia:
# 1. Variables de entorno
# 2. Archivo de configuraci칩n local (./moodle_backup.conf)
# 3. Archivo de configuraci칩n global (/etc/moodle_backup.conf)
# 4. Valores por defecto en el script

# ===================== EJEMPLOS DE CONFIGURACI칍N MULTI-CLIENTE =====================

# --- EJEMPLO 1: CLIENTE B츼SICO (hosting compartido) ---
# CLIENT_NAME=cliente_basico
# CLIENT_DESCRIPTION="Cliente B치sico - Hosting Compartido"
# PANEL_USER=cliente1
# WWW_DIR=""  # Auto-detecci칩n
# MOODLEDATA_DIR=""  # Auto-detecci칩n
# DB_NAME=""  # Auto-detecci칩n
# DB_USER=""  # Auto-detecci칩n
# NOTIFICATION_EMAILS_EXTRA="admin@cliente1.com"
# MAX_BACKUPS_GDRIVE=2

# --- EJEMPLO 2: CLIENTE PREMIUM (VPS dedicado) ---
# CLIENT_NAME=cliente_premium
# CLIENT_DESCRIPTION="Cliente Premium - VPS Dedicado"
# WWW_DIR=/var/www/moodle
# MOODLEDATA_DIR=/var/moodledata
# TMP_DIR=/backup_tmp
# GDRIVE_REMOTE=gdrive_premium:backups
# FORCE_THREADS=12
# FORCE_COMPRESSION_LEVEL=6
# MAX_BACKUPS_GDRIVE=7
# OPTIMIZED_HOURS=00-06
# NOTIFICATION_EMAILS_EXTRA="admin@premium.com,tech@premium.com"
# EXTENDED_DIAGNOSTICS=true

# --- EJEMPLO 3: ENTORNO DE DESARROLLO ---
# CLIENT_NAME=dev_ambiente
# CLIENT_DESCRIPTION="Entorno Desarrollo"
# PANEL_USER=developer
# WWW_DIR=/home/developer/public_html/moodle_dev
# MOODLEDATA_DIR=/home/developer/moodledata_dev
# DB_NAME=dev_moodle
# DB_USER=dev_user
# GDRIVE_REMOTE=gdrive_dev:moodle_backups_dev
# MAX_BACKUPS_GDRIVE=5
# FORCE_COMPRESSION_LEVEL=1  # R치pido para desarrollo
# NOTIFICATION_EMAILS_EXTRA="dev@empresa.com"

# --- EJEMPLO 4: CONFIGURACI칍N M칈NIMA (solo nombres) ---
# CLIENT_NAME=cliente_simple
# CLIENT_DESCRIPTION="Cliente Simple"
# NOTIFICATION_EMAILS_EXTRA="admin@simple.com"
# # Todo lo dem치s se auto-detecta

# ===================== CONFIGURACI칍N MULTI-ENTORNO =====================

# Para usar el mismo script en m칰ltiples entornos:

# 1. CONFIGURACI칍N POR DIRECTORIO:
#    cd /backup/cliente1 && ./moodle_backup.sh
#    cd /backup/cliente2 && ./moodle_backup.sh

# 2. CONFIGURACI칍N POR VARIABLE DE ENTORNO:
#    CLIENT_NAME=cliente1 ./moodle_backup.sh
#    CLIENT_NAME=cliente2 ./moodle_backup.sh

# 3. CONFIGURACI칍N CON ARCHIVO ESPEC칈FICO:
#    CONFIG_FILE=/etc/cliente1.conf ./moodle_backup.sh
#    CONFIG_FILE=/etc/cliente2.conf ./moodle_backup.sh

# 4. CONFIGURACI칍N CRON MULTI-CLIENTE:
#    0 2 * * * cd /backup/cliente1 && ./moodle_backup.sh >/dev/null 2>&1
#    0 3 * * * cd /backup/cliente2 && ./moodle_backup.sh >/dev/null 2>&1
#    0 4 * * * CLIENT_NAME=cliente3 /usr/local/bin/moodle_backup.sh >/dev/null 2>&1

# ===================== RECOMENDACIONES DE SEGURIDAD =====================

# 1. CONTRASE칌AS:
#    - Usar variables de entorno: export MYSQL_PASSWORD="password"
#    - Usar archivo protegido: echo "password" > /etc/mysql/backup.pwd && chmod 600 /etc/mysql/backup.pwd
#    - NUNCA hardcodear en este archivo de configuraci칩n

# 2. PERMISOS:
#    - chmod 600 moodle_backup.conf  # Solo el propietario puede leer
#    - chown root:root moodle_backup.conf  # Propietario root

# 3. LOGS:
#    - Los logs pueden contener rutas e informaci칩n sensible
#    - Rotar y comprimir logs regularmente
#    - Proteger directorio de logs: chmod 750 /var/log

# 4. DIRECTORIO TEMPORAL:
#    - Asegurar que TMP_DIR tiene suficiente espacio
#    - Verificar que se limpia correctamente tras errores
#    - Usar directorios con permisos restrictivos

# ===================== VALIDACI칍N DE CONFIGURACI칍N =====================

# ===================== EJEMPLOS DE CONFIGURACI칍N POR PANEL =====================

# ---------------------- EJEMPLO: cPanel ----------------------
# CLIENT_NAME=mi_cliente_cpanel
# PANEL_TYPE=cpanel
# PANEL_USER=miusuario
# WWW_DIR=/home/miusuario/public_html/moodle
# MOODLEDATA_DIR=/home/miusuario/moodledata
# # Las credenciales de BD se auto-detectan desde config.php

# ---------------------- EJEMPLO: Plesk ----------------------
# CLIENT_NAME=mi_cliente_plesk
# PANEL_TYPE=plesk
# DOMAIN_NAME=midominio.com
# WWW_DIR=/var/www/vhosts/midominio.com/httpdocs
# MOODLEDATA_DIR=/var/www/vhosts/midominio.com/moodledata
# # Usuario puede ser irrelevante en Plesk

# ---------------------- EJEMPLO: DirectAdmin ----------------------
# CLIENT_NAME=mi_cliente_da
# PANEL_TYPE=directadmin
# PANEL_USER=usuario_da
# DOMAIN_NAME=midominio.com
# WWW_DIR=/home/usuario_da/domains/midominio.com/public_html
# MOODLEDATA_DIR=/home/usuario_da/moodledata

# ---------------------- EJEMPLO: VestaCP/HestiaCP ----------------------
# CLIENT_NAME=mi_cliente_vesta
# PANEL_TYPE=vestacp
# PANEL_USER=usuario_vesta
# DOMAIN_NAME=midominio.com
# WWW_DIR=/home/usuario_vesta/web/midominio.com/public_html
# MOODLEDATA_DIR=/home/usuario_vesta/moodledata

# ---------------------- EJEMPLO: ISPConfig ----------------------
# CLIENT_NAME=mi_cliente_isp
# PANEL_TYPE=ispconfig
# DOMAIN_NAME=midominio.com
# WWW_DIR=/var/www/midominio.com/web
# MOODLEDATA_DIR=/var/www/midominio.com/moodledata

# ---------------------- EJEMPLO: Instalaci칩n Manual ----------------------
# CLIENT_NAME=mi_cliente_manual
# PANEL_TYPE=manual
# WWW_DIR=/var/www/html/moodle
# MOODLEDATA_DIR=/var/moodledata
# AUTO_DETECT_AGGRESSIVE=true  # Para b칰squeda agresiva si no se encuentra

# ---------------------- EJEMPLO: Auto-detecci칩n completa ----------------------
# CLIENT_NAME=auto_cliente
# PANEL_TYPE=auto           # Detecta autom치ticamente el panel
# REQUIRE_CONFIG=false      # Permite auto-detecci칩n
# AUTO_DETECT_AGGRESSIVE=true
# # Todas las dem치s variables vac칤as para auto-detecci칩n completa

# ===================== USO Y VALIDACI칍N =====================

# Para validar la configuraci칩n antes de ejecutar el backup:
# ./moodle_backup.sh --show-config

# Para probar solo la conexi칩n a Google Drive:
# ./moodle_backup.sh --test-rclone

# Para diagn칩stico completo del sistema:
# ./moodle_backup.sh --diagnose

# ===================== NOTAS DE SEGURIDAD =====================
#
# 1. PERMISOS: Asegurar que este archivo tenga permisos 600 (solo lectura del propietario)
#    chmod 600 moodle_backup.conf
#
# 2. UBICACI칍N: Preferir ubicaci칩n fuera de public_html para mayor seguridad
#
# 3. CREDENCIALES: No incluir contrase침as de BD aqu칤, usar auto-detecci칩n desde config.php
#
# 4. VALIDACI칍N: Siempre ejecutar --show-config antes del primer backup real
#
# 5. PANEL_TYPE: Si no est치s seguro del tipo de panel, usar 'auto' y verificar
#    la detecci칩n con --show-config
